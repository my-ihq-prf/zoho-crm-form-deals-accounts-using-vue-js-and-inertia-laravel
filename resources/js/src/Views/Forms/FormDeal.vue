
<script setup>

import { useForm } from '@inertiajs/inertia-vue3'

import consts from '@/src/consts.js'

import JetInput from '@/Jetstream/Input.vue'

import JetLabel from '@/Jetstream/Label.vue'
import JetValidationErrors from '@/Jetstream/ValidationErrors.vue'
import useDeals from '@/src/Composables/API/private/use-deals.js'

const props = defineProps({
   itm: Object,
   acc: Object,
   crud: String,
   onNext: { type: Function, default: () => {} },
   onClose: { type: Function, default: () => {} }
})

const setLoaded = (on) => {
   if (props.crud !== 'delete') {
      consts.setStateDlgLoaded(on)
   } else {
      consts.setStateDlgLoaded(false)
   }
}

const form = useForm({
   Account_Name: {
      name: '',
      id: ''
   },
   id: '',
   Deal_Name: '',
   Stage: ''
})

const onSubmit = (_onSuccess) => {
   let ntf = () => {}
   if (props.crud === 'create') {
      ntf = () => consts.notyf.success('The app has successfully created the deal!')
   } else if (props.crud === 'update') {
      ntf = () => consts.notyf.success(`The app has successfully updated the deal with ID:${props.id}`)
   } else if (props.crud === 'delete') {
      ntf = () => consts.notyf.success(`The app has successfully deleted the deal with ID:${props.id}`)
   }
   const d = {
      ...form
   }
   const closingDate = (() => {
      const d1 = new Date()
      const d2 = new Date()
      d1.setDate(d2.getDate() + Math.floor(Math.random() * (13 - 6 + 1) + 6))
      return d1.toJSON().replace(/^([\d]{4}-[\d]{2}-[\d]{2}).*/i, '$1')
   })()

   setLoaded(true)
   useDeals()[props.crud]({
      ...d,
      ...{ Account_Name: { ...props.acc } },
      ...props.crud === 'create' ? { Closing_Date: closingDate, Amount: Math.floor(Math.random() * (199 - 46 + 1) + 46) + '000' } : {}
   }).then((...args) => {
      setLoaded(false)
      // consts.refresMainAccounts()
      if (typeof _onSuccess === 'function') {
         _onSuccess()
      }
      if (typeof props.onNext === 'function') {
         props.onNext()
      }

      ntf()
   }).catch(e => {
      setLoaded(false)
      return e
   })
}
Object.assign(form, {
   id: props.itm.id,
   Deal_Name: props.itm.Deal_Name,
   Stage: props.itm.Stage
})

if (props.crud === 'delete') {
   props.onClose()
   onSubmit()
}

defineExpose({ submit: onSubmit })
</script>
<template>
  <div class="flex flex-col items-center">
    <div class="pt-5 pb-0"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
        viewBox="-25 -25 2575.7 2600.3" stroke-width="22" class="w-32 h-32 text-gray-400">
        <path
          d="m1194.8 5.0298c-75.07 9.8572-149.09 13.934-223.34 31.535-226.3 53.649-438.41 169.04-603.23 333.87-112.23 112.23-204.3 247.34-266.81 393.22-238.23 555.96-45.172 1214.9 456.69 1554.3 103.85 70.22 219.9 124.3 340.02 160.09 172.69 51.456 355.01 64.216 533.36 41.452 635.38-81.097 1121.2-664.31 1093.3-1302.4-24.925-569.17-435.93-1061.9-993.25-1184.8-105.76-23.328-228.46-41.382-336.68-27.175m3.3335 49.542c115.56-13.637 244.69 6.4703 356.68 34.472 548.91 137.23 944.76 657.29 919.91 1224.6-25.915 591.78-487.83 1096.1-1079.9 1159.5-169.18 18.124-340.66 1.0268-503.36-49.532-107.57-33.432-209.78-84.207-303.35-146.59-501.37-334.25-683.84-1010.7-414.18-1550.1 67.433-134.87 158.81-258.13 270.84-359.45 155.57-140.71 345.86-238.29 550.03-285.08 67.427-15.451 135.06-19.828 203.34-27.885m-360.02 569.07h106.67c15.327 0 35.862 3.4902 50.002-3.4135 63.966-31.222 101.55-114.98 166.67-142.87 12.124-5.1902 27.468 1.7701 40.002 2.6468 18.291 1.2734 35.018-5.3203 52.769-5.2969 17.931 0.0233 38.038 26.988 50.569 37.979 38.392 33.675 76.557 78.367 120.01 105.15 14.334 8.8338 33.888 5.807 50.002 5.807h110.01c-14.547-25.401-44.986-44.526-66.67-63.89-56.523-50.469-121.12-97.798-172.5-153.44-14.247-15.434 3.7768-54.983 0.5267-76.017-11.794-76.3-79.061-132.67-158.04-118.46-55.549 9.9972-105.46 57.186-109.71 115.12-1.6034 21.854 12.154 62.946-1.1401 79.874-65.447 83.317-177.16 130.59-239.17 216.81m370.02-318.77c49.279-6.057 59.233 71.677 10 80.017-52.466 8.8838-62.836-73.527-10-80.017m-486.69 380.24c-122.66 19.308-140.01 129.15-140.01 231.88v970.05c0 43.652-1.2901 89.311 25.458 126.67 60.476 84.478 194.22 56.67 284.56 56.67h563.36c88.234 0 189.91 14.094 276.68-1.5468 133.89-24.141 110.01-178.39 110.01-278.47v-730.04c0-92.291 25.164-226.36-28.411-306.68-61.113-91.621-183.53-70.003-278.27-70.003h-543.36c-87.048 0-184.07-12.064-270.01 1.4634m10 113.27c23.431-5.8436 52.599-1.3967 76.67-1.3967h840.04c26.008 0 53.819-3.6602 71.16 20.144 14.304 19.634 8.8438 50.266 8.8438 73.194v996.72c0 30.235-2.7835 59.246-36.668 69.423-26.041 7.8203-56.439 3.9135-83.337 3.9135h-836.71c-26.095-0.01-54.303-1.8034-69.243-26.718-12.804-21.354-7.427-52.726-7.427-76.62v-993.38c0.01-27.561 5.1402-57.409 36.668-65.273m156.67 76.834c-159.83 29.948-105.78 275.22 53.336 243.57 158.28-31.478 103.63-272.98-53.336-243.57m26.668 33.685c113.91 0 113.48 177.5 0 177.5-115.09 0.01-115.81-177.5 0-177.5m213.41 0.56336c-22.948 9.1638-19.704 39.675 3.2869 46.082 35.195 9.8138 83.474 1.4467 119.99 1.4467h253.35c28.848 0 99.955 12.804 121.89-8.3804 12.687-12.251 6.897-32.792-8.7005-39.149-22.634-9.2238-58.976-2.4734-83.191-2.4734h-283.35c-35.098 0-90.578-10.581-123.28 2.4734m-230.07 110.87c-5.4436-11.431-32.508-50.062-44.132-22.571-9.9972 23.645 37.158 83.724 63.036 61.126 19.641-17.151 44.422-57.693 54.133-81.891 4.9602-12.361 0.0967-28.375-16.071-25.028-22.388 4.6369-42.515 51.659-56.966 68.363m223.84 23.428c-16.784 9.9371-11.307 36.652 6.3203 41.795 25.398 7.4103 60.146 1.4467 86.524 1.4467h180.01c21.471 0 69.15 8.8938 85.224-7.727 13.171-13.614 6.767-35.445-11.937-38.449-80.017-12.847-172.16-0.4933-253.3-0.4933-24.198 0-71.7-9.0938-92.844 3.4268m-233.84 211.48c-93.128 17.448-127.77 135.19-68.443 204.99 29.621 34.852 77.894 46.892 121.78 39.059 158.64-28.318 104.01-273.53-53.336-244.05m26.668 33.685c114.12 0 113.09 174.87 0 177.67-114.81 2.8434-116.03-177.67 0-177.67m213.41 0.5633c-22.948 9.1638-19.704 39.675 3.2869 46.082 35.195 9.8138 83.474 1.4467 119.99 1.4467h253.35c28.848 0 99.955 12.804 121.89-8.3804 12.784-12.341 6.8436-32.308-8.7005-38.645-23.081-9.4038-58.573-2.9768-83.191-2.9768h-283.35c-35.098 0-90.578-10.58-123.28 2.4734m-223.41 110.87h-6.667c-5.4436-11.431-32.508-50.062-44.132-22.571-12.351 29.205 42.825 89.274 70.657 52.426 12.657-16.761 55.846-67.837 47.989-89.364-4.7969-13.134-20.594-10.184-28.645-2.3801-15.534 15.057-32.442 41.499-39.202 61.89m217.17 23.428c-16.784 9.9371-11.307 36.652 6.3203 41.795 25.398 7.4104 60.146 1.4468 86.524 1.4468h180.01c21.428 0 69.21 8.9037 85.224-7.7271 12.807-13.301 6.3004-35.495-11.947-38.448-79.951-12.931-172.2-0.4934-253.29-0.4934-24.198 0-71.7-9.0937-92.844 3.4269m-233.84 211.48c-160.06 29.998-105.5 274.49 53.336 244.08 158.41-30.325 103.73-273.52-53.336-244.08m240.08 34.248c-22.948 9.1638-19.704 39.675 3.2869 46.082 35.195 9.8138 83.474 1.4467 119.99 1.4467h253.35c28.848 0 99.955 12.804 121.89-8.3804 12.784-12.341 6.8436-32.308-8.7005-38.642-23.081-9.4071-58.573-2.9801-83.191-2.9801h-283.35c-35.098 0-90.578-10.581-123.28 2.4734m-233.41 1.9568c116.55-20.438 149.03 152.52 33.335 174.02-108.25 20.118-143.69-154.67-33.335-174.02m10 108.91h-6.667c-6.0036-12.047-34.478-50.709-44.476-19.804-6.377 19.718 32.388 70.937 54.346 63.816 23.121-7.5003 45.649-57.33 57.763-77.347 8.3804-13.841 9.0671-48.056-16.544-33.228-17.911 10.37-38.085 47.449-44.422 66.563m217.17 23.428c-16.784 9.9371-11.307 36.652 6.3203 41.795 25.398 7.4103 60.146 1.4467 86.524 1.4467h180.01c21.471 0 69.15 8.8938 85.224-7.727 13.171-13.614 6.767-35.445-11.937-38.449-80.014-12.847-172.16-0.4933-253.3-0.4933-24.198 0-71.7-9.0938-92.844 3.4268">
        </path>
      </svg></div>
    <JetValidationErrors class="mb-4" />

    <form @submit.prevent="onSubmit" class="w-full max-w-md py-8">

      <div>
        <JetLabel for="name" value="Name" />
        <JetInput id="name" v-model="form.Deal_Name" type="text" class="mt-1 block w-full" required autofocus
          autocomplete="deal name" />
      </div>

      <div class="mt-4">
        <JetLabel for="stage" value="Stage" />
        <JetInput id="stage" v-model="form.Stage" type="text" class="mt-1 block w-full" required autofocus
          autocomplete="deal stage" />
      </div>

    </form>

  </div>
</template>
